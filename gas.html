<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi√°m s√°t kh√≠ gas</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Giao di·ªán s√°ng (m·∫∑c ƒë·ªãnh) */
        html {
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Giao di·ªán t·ªëi (dark mode) */
        html.dark {
            background-color: #1f2937;
            color: #d1d5db;
        }
        /* ƒêi·ªÅu ch·ªânh c√°c ph·∫ßn t·ª≠ trong dark mode */
        html.dark .bg-red-100 {
            background-color: #1a0f38e0;
            color: #f3f4f6;
        }
        html.dark .bg-yellow-100 {
            background-color: #1a0f38e0;
            color: #f3f4f6;
        }
        html.dark .bg-gray-100 {
            background-color: #1a0f38e0;
            color: #f3f4f6;
        }
        html.dark .bg-white {
            background-color: #1a0f38e0;
            color: #f3f4f6;
        }
        html.dark .text-red-600 {
            color: #f87171;
        }
        html.dark .text-gray-700 {
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="container mx-auto mt-10 px-4">
        <h2 class="text-2xl font-semibold mb-4">Gi√°m s√°t kh√≠ gas</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-red-100 p-4 rounded shadow">
                <p class="text-lg font-medium">N·ªìng ƒë·ªô kh√≠ gas (ppm):</p>
                <p id="gas-value" class="text-3xl font-bold text-red-600">0</p>
            </div>
            <div class="bg-yellow-100 p-4 rounded shadow flex items-center justify-between">
                <p class="text-lg font-medium">Tr·∫°ng th√°i c√≤i:</p>
                <p id="buzzer-status" class="text-xl font-semibold">ƒêang t·∫Øt</p>
                <button id="buzzer-toggle" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 disabled:opacity-50">B·∫≠t c√≤i</button>
            </div>
        </div>
        <div class="mb-6 flex items-center gap-6">
            <label class="flex items-center cursor-pointer">
                <span class="mr-3 text-lg font-medium text-purple-600">Ch·∫ø ƒë·ªô t·ª± ƒë·ªông</span>
                <div class="relative">
                    <input type="checkbox" id="mode-toggle" class="sr-only peer" checked />
                    <div class="w-12 h-7 bg-gray-300 rounded-full peer-checked:bg-green-600 transition-colors"></div>
                    <div class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-5 transition-transform"></div>
                </div>
            </label>
            <button id="voice-control" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">üéôÔ∏è ƒêi·ªÅu khi·ªÉn b·∫±ng gi·ªçng n√≥i</button>
        </div>
        <div class="mb-6 flex items-center gap-6">
            <label class="flex items-center cursor-pointer">
                <p id="mode-status" class="text-lg font-medium text-purple-600">Ch·∫ø ƒë·ªô: Ban ng√†y</p>
                <div class="relative">
                    <input type="checkbox" id="night-mode-toggle" class="sr-only peer" />
                    <div class="w-12 h-7 bg-gray-300 rounded-full peer-checked:bg-blue-600 transition-colors"></div>
                    <div class="absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow peer-checked:translate-x-5 transition-transform"></div>
                </div>
            </label>
        </div>
        <div class="bg-gray-100 p-4 rounded shadow">
            <p class="text-lg font-medium">Ng∆∞·ª°ng k√≠ch ho·∫°t c√≤i (ppm):</p>
            <input id="threshold-input" type="number" value="2000" min="0" class="w-full p-2 mt-2 border rounded" />
            <button id="update-threshold" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">C·∫≠p nh·∫≠t</button>
            <p id="current-threshold" class="mt-2 text-lg">Ng∆∞·ª°ng hi·ªán t·∫°i: 2000 ppm</p>
        </div>
        <div class="bg-white p-4 rounded shadow mt-6">
            <canvas id="gas-chart" width="400" height="200"></canvas>
        </div>
    </div>
    <script type="module" src="./src/js/firebase.js"></script>
    <script type="module" src="./src/js/script.js"></script>
    <script>
        // Khai b√°o bi·∫øn client to√†n c·ª•c ƒë·ªÉ s·ª≠ d·ª•ng cho MQTT
        let client;

        // Kh·ªüi t·∫°o khi trang web ƒë∆∞·ª£c t·∫£i
        document.addEventListener("DOMContentLoaded", () => {
            // C√°c h·∫±ng s·ªë v√† bi·∫øn tr·∫°ng th√°i
            const EMAIL_COOLDOWN = 5 * 60 * 1000; // Th·ªùi gian ch·ªù gi·ªØa c√°c email th√¥ng b√°o (5 ph√∫t)
            let threshold = 2000; // Ng∆∞·ª°ng k√≠ch ho·∫°t c√≤i ban ƒë·∫ßu
            let autoMode = true; // Ch·∫ø ƒë·ªô t·ª± ƒë·ªông m·∫∑c ƒë·ªãnh b·∫≠t
            let lastEmailSentTime = 0; // Th·ªùi ƒëi·ªÉm g·ª≠i email cu·ªëi c√πng
            let gasChart; // ƒê·ªëi t∆∞·ª£ng bi·ªÉu ƒë·ªì Chart.js
            let voiceAlertCount = 0; // ƒê·∫øm s·ªë l·∫ßn th√¥ng b√°o gi·ªçng n√≥i
            let wasBelowThreshold = true; // Theo d√µi tr·∫°ng th√°i tr∆∞·ªõc ƒë√≥ (d∆∞·ªõi ng∆∞·ª°ng)

            // ƒê·∫£m b·∫£o n√∫t b·∫≠t/t·∫Øt c√≤i b·ªã v√¥ hi·ªáu h√≥a khi kh·ªüi t·∫°o ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông
            document.getElementById("buzzer-toggle").disabled = autoMode;

            // H√†m kh·ªüi t·∫°o bi·ªÉu ƒë·ªì hi·ªÉn th·ªã n·ªìng ƒë·ªô kh√≠ gas
            const initChart = () => {
                const ctx = document.getElementById("gas-chart").getContext("2d");
                gasChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: [], // Nh√£n th·ªùi gian
                        datasets: [{
                            label: "N·ªìng ƒë·ªô kh√≠ gas (ppm)",
                            data: [], // D·ªØ li·ªáu kh√≠ gas
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderColor: "rgb(255, 99, 132)",
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        scales: {
                            x: { title: { display: true, text: "Th·ªùi gian" } },
                            y: { beginAtZero: true, suggestedMax: 5000 }
                        }
                    }
                });
            };

            // H√†m c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì v·ªõi th·ªùi gian v√† gi√° tr·ªã kh√≠ gas m·ªõi
            const updateChart = (time, value) => {
                if (gasChart.data.labels.length >= 20) { // Gi·ªõi h·∫°n 20 ƒëi·ªÉm d·ªØ li·ªáu
                    gasChart.data.labels.shift();
                    gasChart.data.datasets[0].data.shift();
                }
                gasChart.data.labels.push(time);
                gasChart.data.datasets[0].data.push(value);
                gasChart.update();
            };

            // H√†m ph√°t gi·ªçng n√≥i (text-to-speech)
            const speak = (text) => {
                const utterance = new SpeechSynthesisUtterance(text); // T·∫°o ƒë·ªëi t∆∞·ª£ng gi·ªçng n√≥i
                utterance.lang = "vi-VN"; // ƒê·∫∑t ng√¥n ng·ªØ l√† ti·∫øng Vi·ªát
                window.speechSynthesis.speak(utterance); // Ph√°t √¢m vƒÉn b·∫£n
            };

            // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i c√≤i (b·∫≠t/t·∫Øt) tr√™n giao di·ªán v√† g·ª≠i l·ªánh MQTT
            const updateBuzzerState = (gasValue, forceOn = false) => {
                const buzzerStatus = document.getElementById("buzzer-status");
                const toggleButton = document.getElementById("buzzer-toggle");
                // X√°c ƒë·ªãnh tr·∫°ng th√°i c√≤i: B·∫≠t n·∫øu √©p bu·ªôc (th·ªß c√¥ng) ho·∫∑c (gi√° tr·ªã kh√≠ gas > ng∆∞·ª°ng v√† ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông)
                const isOn = forceOn || (gasValue > threshold && autoMode);

                // C·∫≠p nh·∫≠t giao di·ªán
                buzzerStatus.textContent = isOn ? "ƒêang b·∫≠t" : "ƒêang t·∫Øt";
                buzzerStatus.classList.toggle("text-red-600", isOn);
                toggleButton.textContent = isOn ? "T·∫Øt c√≤i" : "B·∫≠t c√≤i";
                toggleButton.classList.toggle("bg-green-500", !isOn);
                toggleButton.classList.toggle("bg-red-500", isOn);
                toggleButton.classList.toggle("hover:bg-green-600", !isOn);
                toggleButton.classList.toggle("hover:bg-red-600", isOn);

                // G·ª≠i l·ªánh b·∫≠t/t·∫Øt c√≤i qua MQTT
                const message = new Paho.MQTT.Message(isOn ? "BUZZER_ON" : "BUZZER_OFF");
                message.destinationName = "HeThongNhaThongMinh/KhiGas/Control/BUZZER";
                client.isConnected() ? client.send(message) : console.error("MQTT kh√¥ng k·∫øt n·ªëi");
            };

            // Kh·ªüi t·∫°o k·∫øt n·ªëi MQTT
            client = new Paho.MQTT.Client("broker.emqx.io", 8084, `gas-client-${Math.random().toString(16).slice(3)}`);
            
            // X·ª≠ l√Ω khi m·∫•t k·∫øt n·ªëi MQTT
            client.onConnectionLost = (res) => {
                console.error("M·∫•t k·∫øt n·ªëi MQTT:", res.errorMessage);
                setTimeout(() => client.connect({ onSuccess: onConnect, useSSL: true }), 5000);
            };

            // X·ª≠ l√Ω khi nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn MQTT t·ª´ topic ƒë√£ subscribe
            client.onMessageArrived = (message) => {
                let gasValue;
                try {
                    const payload = JSON.parse(message.payloadString);
                    gasValue = parseFloat(payload.khigas); // L·∫•y gi√° tr·ªã kh√≠ gas
                    if (isNaN(gasValue) || gasValue < 0) return;
                } catch (error) {
                    console.error("L·ªói JSON:", error);
                    return;
                }

                // C·∫≠p nh·∫≠t gi√° tr·ªã kh√≠ gas tr√™n giao di·ªán
                const time = new Date().toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                document.getElementById("gas-value").textContent = gasValue.toFixed(0);
                updateChart(time, gasValue);

                // L∆∞u d·ªØ li·ªáu kh√≠ gas v√†o Firebase
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        const db = firebase.database();
                        const timestamp = Date.now();
                        db.ref(`users/${user.uid}/sensors/gas/${timestamp}`).set({ khigas: gasValue, timestamp });

                        // G·ª≠i th√¥ng  th√¥ng b√°o qua Firebase n·∫øu kh√≠ gas v∆∞·ª£t ng∆∞·ª°ng
                        if (gasValue > threshold && Date.now() - lastEmailSentTime >= EMAIL_COOLDOWN) {
                            db.ref(`users/${user.uid}/notifications`).push({
                                type: "gas_alert",
                                gasValue,
                                timestamp,
                                status: "pending"
                            });
                            lastEmailSentTime = Date.now();
                        }
                    }
                });

                // ƒêi·ªÅu khi·ªÉn c√≤i v√† th√¥ng b√°o gi·ªçng n√≥i d·ª±a tr√™n gi√° tr·ªã kh√≠ gas ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông
                if (autoMode) {
                    updateBuzzerState(gasValue); // Ki·ªÉm tra ng∆∞·ª°ng v√† b·∫≠t/t·∫Øt c√≤i t·ª± ƒë·ªông
                    if (gasValue > threshold) {
                        if (voiceAlertCount < 3) {
                            voiceAlertCount++;
                            speak(`C·∫£nh b√°o! Kh√≠ gas v∆∞·ª£t ng∆∞·ª°ng: ${gasValue} pi pi en`);
                        }
                        wasBelowThreshold = false;
                    } else {
                        // ƒê·∫∑t l·∫°i bi·∫øn ƒë·∫øm n·∫øu kh√≠ gas xu·ªëng d∆∞·ªõi ng∆∞·ª°ng
                        if (!wasBelowThreshold) {
                            voiceAlertCount = 0;
                            wasBelowThreshold = true;
                        }
                    }
                }
            };

            // H√†m g·ªçi khi k·∫øt n·ªëi MQTT th√†nh c√¥ng
            const onConnect = () => {
                console.log("K·∫øt n·ªëi MQTT th√†nh c√¥ng");
                client.subscribe("HeThongNhaThongMinh", (err) => {
                    if (err) console.error("L·ªói subscribe:", err);
                    else console.log("ƒê√£ subscribe: HeThongNhaThongMinh");
                });
            };

            // K·∫øt n·ªëi t·ªõi MQTT broker
            client.connect({ 
                onSuccess: onConnect, 
                onFailure: (err) => {
                    console.error("K·∫øt n·ªëi MQTT th·∫•t b·∫°i:", err.errorMessage);
                    setTimeout(() => client.connect({ onSuccess: onConnect, useSSL: true }), 5000);
                }, 
                useSSL: true 
            });

            // X·ª≠ l√Ω tr·∫°ng th√°i ƒëƒÉng nh·∫≠p Firebase v√† t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
            firebase.auth().onAuthStateChanged((user) => {
                if (!user) return console.warn("Ch∆∞a ƒëƒÉng nh·∫≠p");

                const db = firebase.database();
                // T·∫£i ng∆∞·ª°ng ƒë√£ l∆∞u t·ª´ Firebase
                db.ref(`users/${user.uid}/settings/threshold`).once("value").then((snapshot) => {
                    const savedThreshold = parseInt(snapshot.val());
                    if (savedThreshold > 0) {
                        threshold = savedThreshold;
                        document.getElementById("threshold-input").value = threshold;
                        document.getElementById("current-threshold").textContent = `Ng∆∞·ª°ng hi·ªán t·∫°i: ${threshold} ppm`;
                    }
                });

                // T·∫£i d·ªØ li·ªáu kh√≠ gas l·ªãch s·ª≠ t·ª´ Firebase ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì
                db.ref(`users/${user.uid}/sensors/gas`).orderByKey().limitToLast(20).once("value").then((snapshot) => {
                    snapshot.forEach((child) => {
                        const data = child.val();
                        const time = new Date(+child.key).toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                        updateChart(time, parseFloat(data.khigas));
                    });
                });
            });

            // X·ª≠ l√Ω s·ª± ki·ªán c·∫≠p nh·∫≠t ng∆∞·ª°ng t·ª´ ng∆∞·ªùi d√πng
            document.getElementById("update-threshold").addEventListener("click", () => {
                const newThreshold = parseInt(document.getElementById("threshold-input").value);
                if (newThreshold > 0) {
                    threshold = newThreshold; // C·∫≠p nh·∫≠t ng∆∞·ª°ng c·ª•c b·ªô
                    // C·∫≠p nh·∫≠t giao di·ªán
                    document.getElementById("current-threshold").textContent = `Ng∆∞·ª°ng hi·ªán t·∫°i: ${threshold} ppm`;
                    // L∆∞u ng∆∞·ª°ng v√†o Firebase
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            firebase.database().ref(`users/${user.uid}/settings/threshold`).set(threshold);
                        }
                    });
                    // G·ª≠i ng∆∞·ª°ng m·ªõi t·ªõi Arduino qua MQTT
                    if (client.isConnected()) {
                        const message = new Paho.MQTT.Message(newThreshold.toString());
                        message.destinationName = "HeThongNhaThongMinh/KhiGas/Control/ThresholdMq2";
                        client.send(message);
                        console.log(`ƒê√£ g·ª≠i ng∆∞·ª°ng ${newThreshold} t·ªõi topic: HeThongNhaThongMinh/KhiGas/Control/ThresholdMq2`);
                    } else {
                        console.error("Kh√¥ng th·ªÉ g·ª≠i ng∆∞·ª°ng: MQTT kh√¥ng k·∫øt n·ªëi");
                    }
                } else {
                    alert("Vui l√≤ng nh·∫≠p gi√° tr·ªã l·ªõn h∆°n 0!");
                }
            });

            // X·ª≠ l√Ω b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông
            document.getElementById("mode-toggle").addEventListener("change", () => {
                autoMode = document.getElementById("mode-toggle").checked;
                document.getElementById("buzzer-toggle").disabled = autoMode; // V√¥ hi·ªáu h√≥a n√∫t c√≤i khi ch·∫ø ƒë·ªô t·ª± ƒë·ªông b·∫≠t
                // G·ª≠i tr·∫°ng th√°i ch·∫ø ƒë·ªô t·ª± ƒë·ªông qua MQTT
                const message = new Paho.MQTT.Message(autoMode ? "ON" : "OFF");
                message.destinationName = "HeThongNhaThongMinh/KhiGas/Control/automodeMq2";
                client.isConnected() ? client.send(message) : console.error("MQTT kh√¥ng k·∫øt n·ªëi");

                // N·∫øu t·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông, gi·ªØ nguy√™n tr·∫°ng th√°i c√≤i
                if (autoMode && client.isConnected()) {
                    const gasValue = parseFloat(document.getElementById("gas-value").textContent);
                    updateBuzzerState(gasValue);
                }
            });

            // X·ª≠ l√Ω n√∫t b·∫≠t/t·∫Øt c√≤i th·ªß c√¥ng
            document.getElementById("buzzer-toggle").addEventListener("click", () => {
                if (!client.isConnected()) return console.error("MQTT kh√¥ng k·∫øt n·ªëi");
                const isOn = document.getElementById("buzzer-status").textContent === "ƒêang b·∫≠t";
                const gasValue = parseFloat(document.getElementById("gas-value").textContent);

                // G·ª≠i l·ªánh b·∫≠t/t·∫Øt c√≤i
                const message = new Paho.MQTT.Message(isOn ? "BUZZER_OFF" : "BUZZER_ON");
                message.destinationName = "HeThongNhaThongMinh/KhiGas/Control/BUZZER";
                client.send(message);
                updateBuzzerState(gasValue, !isOn);
            });

            // X·ª≠ l√Ω ch·∫ø ƒë·ªô ban ƒë√™m
            document.getElementById("night-mode-toggle").addEventListener("change", () => {
                const nightMode = document.getElementById("night-mode-toggle").checked;
                document.documentElement.classList.toggle("dark", nightMode);
                document.getElementById("mode-status").textContent = `Ch·∫ø ƒë·ªô: ${nightMode ? "Ban ƒë√™m" : "Ban ng√†y"}`;
            });

            // X·ª≠ l√Ω ƒëi·ªÅu khi·ªÉn b·∫±ng gi·ªçng n√≥i
            const voiceControlBtn = document.getElementById("voice-control");
            if ("webkitSpeechRecognition" in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.lang = "vi-VN";
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const command = event.results[0][0].transcript.toLowerCase();
                    if (command.includes("b·∫≠t c√≤i")) {
                        if (autoMode) {
                            speak("Kh√¥ng th·ªÉ b·∫≠t c√≤i: ƒêang ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông!");
                        } else if (client.isConnected()) {
                            updateBuzzerState(0, true); // B·∫≠t c√≤i
                            speak("ƒê√£ b·∫≠t c√≤i.");
                        } else {
                            speak("Kh√¥ng th·ªÉ k·∫øt n·ªëi h·ªá th·ªëng!");
                        }
                    } else if (command.includes("t·∫Øt c√≤i")) {
                        if (autoMode) {
                            speak("Kh√¥ng th·ªÉ t·∫Øt c√≤i: ƒêang ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông!");
                        } else if (client.isConnected()) {
                            const gasValue = parseFloat(document.getElementById("gas-value").textContent);
                            updateBuzzerState(gasValue, false); // T·∫Øt c√≤i
                            speak("ƒê√£ t·∫Øt c√≤i.");
                        } else {
                            speak("Kh√¥ng th·ªÉ k·∫øt n·ªëi h·ªá th·ªëng!");
                        }
                    } else if (command.includes("kh√≠ ga")) {
                        const gasValue = document.getElementById("gas-value").textContent;
                        let status = gasValue >= threshold ? "Kh√≠ gas v∆∞·ª£t ng∆∞·ª°ng!" : "An to√†n";
                        speak(`N·ªìng ƒë·ªô kh√≠ gas: ${gasValue} pi pi en. Tr·∫°ng th√°i: ${status}.`);
                    } else if (command.includes("ng∆∞·ª°ng")) {
                        const match = command.match(/\d+/);
                        if (match && parseInt(match[0]) > 0) {
                            threshold = parseInt(match[0]);
                            document.getElementById("threshold-input").value = threshold;
                            document.getElementById("current-threshold").textContent = `Ng∆∞·ª°ng hi·ªán t·∫°i: ${threshold} ppm`;
                            // L∆∞u ng∆∞·ª°ng v√†o Firebase
                            firebase.auth().onAuthStateChanged((user) => {
                                if (user) {
                                    firebase.database().ref(`users/${user.uid}/settings/threshold`).set(threshold);
                                }
                            });
                            // G·ª≠i ng∆∞·ª°ng qua MQTT
                            if (client.isConnected()) {
                                const message = new Paho.MQTT.Message(threshold.toString());
                                message.destinationName = "HeThongNhaThongMinh/KhiGas/Control/ThresholdMq2";
                                client.send(message);
                            }
                            speak(`ƒê√£ ƒë·ªïi ng∆∞·ª°ng th√†nh ${threshold} pi pi en.`);
                        } else {
                            speak("Gi√° tr·ªã ng∆∞·ª°ng kh√¥ng h·ª£p l·ªá!");
                        }
                    } else {
                        speak("L·ªánh kh√¥ng nh·∫≠n di·ªán!");
                    }
                };

                recognition.onerror = (event) => {
                    console.error("L·ªói gi·ªçng n√≥i:", event.error);
                    speak("L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i!");
                };

                voiceControlBtn.addEventListener("click", () => {
                    recognition.start();
                    speak("Vui l√≤ng n√≥i l·ªánh...");
                });
            } else {
                voiceControlBtn.innerText = "Gi·ªçng n√≥i kh√¥ng h·ªó tr·ª£";
                voiceControlBtn.disabled = true;
            }

            // Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì khi t·∫£i trang
            initChart();
        });
    </script>
</body>
</html>